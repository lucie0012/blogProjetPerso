<div class="container my-5">
    <h1 class="colorWrite">Répertoire</h1>
    <div class="row mt-4">
        <div class="col-md-9 mb-4">
            <p>Eius populus ab incunabulis primis ad usque pueritiae tempus extremum, quod annis circumcluditur fere
                trecentis,
                circummurana pertulit bella, deinde aetatem ingressus adultam post multiplices bellorum aerumnas
            </p>
        </div>
        <div class="col-md-3">
            {{#if isVerified}}
            <a class="btn btnSite d-flex align-items-center mb-3" type="button" data-toggle="modal"
                data-target="#modalPropoSite" data-whatever="@getbootstrap"><i
                    class="far fa-plus-square fa-2x mx-2"></i>Proposer un site</a>
            {{/if}}
        </div>
    </div>

    <div class="row">
        <div class="col-md-9" id="recharger">
            {{#each dbRepertory }}
            {{#if isVerified}}
            <div class="card cardRepertory mb-5" style="max-width: 600px;">
                <div class="row no-gutters">
                    <div class="col-md-4">
                        <img src="{{ image }}" class="card-img" alt="image du site">
                    </div>
                    <div class="col-md-8">
                        <div class="card-header">
                            <small class="text-muted">Dans catégorie :
                                {{#contains category "sansGluten" }}
                                Sans gluten
                                {{/contains }}
                                {{#contains category "sansLactose" }}
                                Sans lactose
                                {{/contains }}
                                {{#contains category "sansOeufs" }}
                                Sans oeufs
                                {{/contains }}
                                {{#contains category "sansCaseine" }}
                                Sans caséine
                                {{/contains }}
                                / Note : </small>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ title }}</h5>
                            <a href="{{ url }}">{{ url }}</a>
                            <p class="card-text mt-2">{{ truncate content 200 }}</p>
                        </div>
                        {{!-- bouton noter --}}
                        {{#if ../userVerified }}
                        {{!-- A REVOIR --}}
                        <div class="d-flex justify-content-end">
                            <button class="btn btnSite mb-2 mr-2" type="button" data-toggle="modal"
                                data-target="#modalNoter{{_id}}" data-whatever="@getbootstrap">Noter</button>
                        </div>
                        {{/if}}
                        {{!-- bouton noter --}}
                    </div>
                </div>
            </div>

            {{!-------------- Modal noter site/répertoire -------------------}}
            <div class="modal fade" id="modalNoter{{_id}}" tabindex="-1" role="dialog"
                aria-labelledby="#modalNoterLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalNoterLabel">Ajouter une note</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <form action="/note/{{ _id }}" method="POST">
                            <div class="container">
                                <div class="row modal-body">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="pseudoComment{{_id}}" class="col-form-label">Votre pseudo :
                                            </label>
                                            <input class="form-control" id="pseudoComment{{_id}}" type="text"
                                                name="pseudo" value="{{ ../dbUserId.pseudo }}" disabled="disabled">
                                            {{!-- pour "sortir" du each et obtenir d'autres infos de bdd il faut utiliser : "../" : (changing the context handlebars) --}}
                                        </div>
                                        <div class="form-group">
                                            <label for="noteSite{{_id}}" class="col-form-label">Votre note : </label>
                                            <input class="form-control" id="noteSite{{_id}}" type="text" name="note"
                                                required>
                                        </div>
                                        <div class="form-group">
                                            <label for="commentNote{{_id}}" class="col-form-label">Votre commentaire :
                                            </label>
                                            <textarea class="form-control" id="commentNote{{_id}}" type="text"
                                                name="comment" required></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-12 ">
                                        <div class="d-flex flex-row-reverse">
                                            <button type="submit" class="btn btnSite ">Poster</button>
                                            <button type="button" class="btn btnSite p-2 mr-2"
                                                data-dismiss="modal">Annuler</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
            {{!-------------------- /Modal noter site/répertoire --------------------}}
            {{/if}}
            {{/each }}
        </div>

        <div class="col-md-3">
            {{!-- <form action="/repertoryFilter" method="POST"> --}}
            <table class="table">
                <thead>
                    <p>Trier par catégorie</p>
                </thead>
                <tbody>
                    <tr>
                        <th scope="row"> <input class="form-check-input" type="checkbox" name="categoryFilter"
                                value="sansGluten" id="sansGluten">
                        </th>
                        <td> <label class="form-check-label" for="sansGluten">
                                Sans gluten
                            </label></td>
                    </tr>
                    <tr>
                        <th scope="row"> <input class="form-check-input" type="checkbox" name="categoryFilter"
                                value="sansLactose" id="sansLactose">
                        </th>
                        <td> <label class="form-check-label" for="sansLactose">
                                Sans lactose
                            </label></td>
                    </tr>
                    <tr>
                        <th scope="row"> <input class="form-check-input" type="checkbox" name="categoryFilter"
                                value="sansOeufs" id="sansOeufs">
                        </th>
                        <td> <label class="form-check-label" for="sansOeufs">
                                Sans oeufs
                            </label></td>
                    </tr>
                    <tr>
                        <th scope="row"> <input class="form-check-input" type="checkbox" name="categoryFilter"
                                value="sansCaseine" id="sansCaseine">
                        </th>
                        <td> <label class="form-check-label" for="sansOeufs">
                                Sans caséine
                            </label></td>
                    </tr>
                    {{!-- <tr>
                        <th scope="row"> <input class="form-check-input" type="checkbox" value="" id="populaires">
                        </th>
                        <td> <label class="form-check-label" for="populaires">
                                Les plus populaires
                            </label></td>
                    </tr> --}}
                </tbody>
            </table>
            {{!-- <button id="rechercher" type="submit" class="btn btnSite">Rechercher</button> --}}
            {{!-- </form> --}}
        </div>

    </div>

</div>

{{!----------------------- Modal proposition site pour répertoire -----------------------}}
<div class="modal fade" id="modalPropoSite" tabindex="-1" role="dialog" aria-labelledby="#modalPropoSite"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">Proposer un site à ajouter dans le répertoire</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <form action="/repertory" method="POST" enctype="multipart/form-data" name="scriptCheckbox"
                id="scriptCheckboxUser">
                {{!-- "form" : correspond au chemin indiqué dans le router.route dans lequel on fera un .post --}}
                {{!-- "method" : correspond à la methode utilisée : ici POST --}}
                {{!-- "enctype="multipart/form-data"" : ne le mettre que si gestion de file (sinon bloque la réception de req.body) --}}
                <div class="container">
                    <div class="row modal-body">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="pseudoModalAddSite">Votre pseudo</label>
                                <input type="text" class="form-control" name="pseudo" id="pseudoModalAddSite"
                                    value="{{ dbUserId.pseudo }}" disabled="disabled">
                            </div>
                            <div class="form-group">
                                <label for="titleModalAddSite">Titre du site</label>
                                <input type="text" class="form-control" name="title" id="titleModalAddSite" required>
                                {{!-- bien indiqué là où on saisi les données (input, textarea, ...) le type (text, file, ...) et le name (qui fait référence au req.body.name) --}}
                            </div>
                            <div class="form-group">
                                <label for="urlModalAddSite">URL du site</label>
                                <input type="text" class="form-control" name="url" id="urlModalAddSite" required>
                            </div>
                            <div class="form-group">
                                <label for="category">Catégorie</label>
                                <label id="messageErrorAddSite" class="text-danger d-none"></label>
                                </br>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input groupCheckboxScript" type="checkbox"
                                        id="inlineCheckbox1" name="category" value="sansGluten">
                                    <label class="form-check-label " for="inlineCheckbox1">Sans gluten</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input groupCheckboxScript" type="checkbox"
                                        id="inlineCheckbox2" name="category" value="sansLactose">
                                    <label class="form-check-label" for="inlineCheckbox2">Sans lactose</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input groupCheckboxScript" type="checkbox"
                                        id="inlineCheckbox3" name="category" value="sansOeufs">
                                    <label class="form-check-label" for="inlineCheckbox3">Sans oeufs</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input groupCheckboxScript" type="checkbox"
                                        id="inlineCheckbox4" name="category" value="sansCaseine">
                                    <label class="form-check-label" for="inlineCheckbox4">Sans caséine</label>
                                </div>

                                {{!-- <label for="category">Catégorie</label>
                                <input type="text" class="form-control" name="category" required> --}}
                            </div>
                            <div class="form-group">
                                <label for="descriptionModalAddSite">Contenu</label>
                                <textarea type="text" class="form-control" name="content" id="descriptionModalAddSite"
                                    required></textarea>
                            </div>

                            <div class="form-group row">
                                <label for="addSitePhoto" class="col-sm-12 col-form-label">Envoyer une image</label>
                            </div>
                            <div class="form-group row">
                                <input type="file" class="form-control-file col-sm-12" id="addSitePhoto" name="image"
                                    value="{{ dbUserId.image }}">
                            </div>

                            {{!-- <div class="form-group">
                                <label>
                                    <input type="file" name="image">
                                    <span>
                                        Envoyer une image
                                    </span>
                                </label>
                            </div> --}}
                        </div>
                        <div class="col-md-12 ">
                            <div class="d-flex flex-row-reverse">
                                <button type="submit" class="btn btnSite">Créer</button>
                                <button type="button" class="btn btnSite mr-2 p-2" data-dismiss="modal">Annuler</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div>
{{!------------------ /Modal proposition site pour répertoire --------------}}

{{!-- SCRIPT CHECKBOX REQUIRE MODAL PROPO SITE --}}
{{!-- requête Ajax avec JQuery --}}
<script>

    $("#scriptCheckboxUser").submit(function (event) {
        //on vérifie que nos conditions d'envoi sont bonnes
        if (countCheckedJQuery() >= 1) {
            console.log("submitted !");
        } else {
            //on empêche le questionnaire de s'envoyer
            event.preventDefault();
            $("#messageErrorAddSite").removeClass("d-none");
            $("#messageErrorAddSite").text("Veuillez cocher au moins une case");
            console.log("unsubmit");
        }
    });

    function countCheckedJQuery() {
        var checked = $(".groupCheckboxScript:checked");//sélectionne tous les éléments de classe "groupcheckbox" qui sont sélectionné
        return checked.length;
    }

</script>
{{!-- /SCRIPT CHECKBOX REQUIRE MODAL PROPO SITE --}}


{{!-- SCRIPT FILTRE CLICK CHECKBOX REPERTORY --}}
{{!-- requête Ajax avec JQuery --}}
<script>

    $(document).ready(function () {
        $("input[name='categoryFilter']").click(function () {
            //console.log("coucou")

            var categories = [];

            $.each($("input[name='categoryFilter']:checked"), function () {
                categories.push($(this).val());
            });

            //console.log(categories)

            $.ajax({
                url: '/repertoryFilter',
                type: 'POST',
                data: {
                    category: categories
                },
                //dataType: 'json',
                success: function (data, json, statut) {
                    //console.log("recherche OK")
                    //console.log(data)
                    //console.log(json)
                    //const dbRepertory = data.dbRepertory;
                    //console.log(dbRepertory)

                    $("#recharger").html(data);

                },
                error: function (resultat, statut, erreur) {
                    console.log(resultat);
                    console.log(statut);
                    console.log(erreur);

                }

            });

        });
    });

</script>
{{!-- /SCRIPT FILTRE CLICK CHECKBOX REPERTORY --}}